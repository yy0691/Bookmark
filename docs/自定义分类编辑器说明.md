# ✏️ 自定义分类编辑器说明

## 概述

自定义分类编辑器是 Phase 2 优化阶段的关键功能，允许用户在分析结果中直接编辑、合并、拆分和重命名分类，提供灵活的分类管理和自定义能力。

## 核心功能

### 1️⃣ 编辑操作

#### 重命名分类
```javascript
// 将分类从 "编程" 改为 "Web开发"
editor.renameCategory("编程", "Web开发", [bookmarkIds])
// 影响所有使用该分类的书签
```

#### 合并分类
```javascript
// 合并多个相似分类
editor.mergeCategories(
  ["编程", "代码", "开发"],  // 源分类
  "编程",                    // 目标分类
  [affectedBookmarkIds]
)
// 所有源分类都会映射到目标分类
```

#### 拆分分类
```javascript
// 将一个大分类拆分为多个小分类
editor.splitCategory(
  "编程",                              // 源分类
  ["Web开发", "数据科学", "系统编程"], // 新分类
  { bookmarkId: "新分类" }             // 书签分配
)
```

### 2️⃣ 智能建议

系统自动分析分类结构并提供改进建议：

```javascript
const suggestions = editor.getEditSuggestions(results)

// 可能的建议：
// 1. 相似分类名称 - "编程" 和 "开发" 相似，考虑合并
// 2. 单项分类 - "AI" 只有1个书签，考虑合并
// 3. 过多分类 - 分类超过15个，考虑简化结构
```

### 3️⃣ 批量编辑

一次执行多个编辑操作：

```javascript
const batch = editor.batchEditCategories([
  {
    type: 'rename',
    oldName: '编程',
    newName: '开发',
    affectedIds: [...]
  },
  {
    type: 'merge',
    sourceCategories: ['视频', '电影'],
    targetCategory: '媒体',
    affectedIds: [...]
  }
])

// 返回统计：成功数、失败数、操作详情
```

### 4️⃣ 分类模板

快速创建常见的分类结构：

```javascript
// 获取模板列表
editor.getCommonCategoryTemplates()
// {
//   tech: ['编程', '开发', '框架', '工具', '数据库', '云计算'],
//   content: ['文章', '博客', '新闻', '视频', '播客', '电子书'],
//   entertainment: ['游戏', '电影', '音乐', '动画', '小说'],
//   productivity: ['任务', '笔记', '文档', '项目管理', '日历'],
//   reference: ['文档', '教程', '参考', '手册', '指南'],
//   social: ['社交媒体', '论坛', '社区', '邮件', '聊天']
// }

// 使用模板
editor.createCategoryStructure('tech')
// 创建完整的技术类分类结构
```

## 技术实现

### CategoryEditor 类

**文件位置:** `modules/categoryEditor.js`

**核心属性：**

```javascript
editHistory[]          // 编辑历史记录
categoryMappings{}     // 分类别名映射（旧→新）
categoryAliases{}      // 分类→别名列表
```

**主要方法：**

| 方法 | 功能 |
|------|------|
| `renameCategory()` | 重命名单个分类 |
| `mergeCategories()` | 合并多个分类 |
| `splitCategory()` | 拆分单个分类 |
| `batchEditCategories()` | 批量编辑 |
| `applyEditsToResults()` | 应用编辑到结果 |
| `getEditSuggestions()` | 获取改进建议 |
| `undoLastEdit()` | 撤销最后编辑 |
| `exportEditConfig()` | 导出配置 |
| `importEditConfig()` | 导入配置 |

## 工作流程

### 编辑流程

```
分析完成，显示结果
  ↓
用户查看分类
  ↓
系统提供编辑建议
  ├─ 检测相似名称
  ├─ 检测单项分类
  └─ 检测结构复杂度
  ↓
用户选择操作
  ├─ 重命名
  ├─ 合并
  ├─ 拆分
  └─ 使用模板
  ↓
执行编辑
  ├─ 更新映射
  ├─ 记录历史
  └─ 验证一致性
  ↓
应用到结果
  ├─ 更新分类
  ├─ 保存映射
  └─ 显示预览
  ↓
用户确认
  ├─ 接受编辑
  ├─ 撤销编辑
  └─ 继续修改
```

## 数据结构

### 编辑记录

```javascript
{
  editId: "edit_1634567890",
  type: "rename" | "merge" | "split",
  timestamp: 1634567890000,
  // 重命名时
  oldName: "编程",
  newName: "开发",
  // 合并时
  sourceCategories: ["编程", "代码"],
  targetCategory: "开发",
  // 拆分时
  newCategories: ["Web", "后端"],
  assignments: { bookmarkId: "新分类" },
  // 通用字段
  affectedCount: 42,
  status: "success" | "failed"
}
```

### 分类映射

```javascript
categoryMappings = {
  "编程": "开发",
  "代码": "开发",
  "开发": "开发"
}

categoryAliases = {
  "开发": Set(["编程", "代码"])
}
```

## 高级特性

### 1. 相似度检测

使用 Levenshtein 距离算法检测相似的分类名称：

```javascript
calculateSimilarity("编程", "编程语言")  // 0.85
calculateSimilarity("开发", "Developer") // 低于阈值
```

**应用场景：**
- 自动建议合并相似分类
- 检测用户输入的重复
- 验证分类名称的唯一性

### 2. 颜色管理

为每个分类自动生成一致的颜色：

```javascript
generateCategoryColor("编程")  // "#45B7D1"
// 相同名称总是生成相同颜色
// 便于用户识别
```

**优势：**
- 增强可视化识别
- 保持颜色一致性
- 支持自定义颜色

### 3. 编辑会话管理

创建编辑会话以管理单个分类的编辑：

```javascript
const session = editor.createEditSession("编程", "#45B7D1")
// {
//   sessionId: "session_...",
//   categoryName: "编程",
//   color: "#45B7D1",
//   isActive: true,
//   bookmarksInCategory: [...],
//   changes: [...]
// }
```

### 4. 批量操作统计

```javascript
const batch = editor.batchEditCategories(operations)
// {
//   batchId: "batch_...",
//   operationCount: 5,
//   successCount: 4,
//   failureCount: 1,
//   operations: [...]
// }
```

## 集成点

### 与学习系统的结合

```
用户编辑分类
  ↓
学习系统记录编辑
  ↓
更新关键词和域名关联
  ↓
下次分类时使用新的映射
```

### 与同步系统的结合

```
编辑完成
  ↓
应用编辑到结果
  ↓
使用编辑后的分类同步到书签
  ↓
更精准的分类结构
```

### 与缓存系统的结合

```
缓存初始分类
  ↓
用户编辑分类
  ↓
更新缓存的分类映射
  ↓
下次直接使用编辑后的结果
```

## 使用场景

### 场景1：简化分类结构

```
初始分类：15 个分类
问题：太多分类，结构复杂

解决：
1. 系统建议合并相似分类
2. 用户使用 tech 模板重新组织
3. 结果：6 个主要分类
```

### 场景2：纠正误分

```
问题：系统误分了某些书签

解决：
1. 用户拆分分类
2. 重新分配书签
3. 系统学习新规则
4. 下次自动应用
```

### 场景3：个性化调整

```
需求：按工作流重新组织分类

操作：
1. 查看初始分类
2. 选择 productivity 模板
3. 调整个别分类名称
4. 完成个性化配置
```

## 最佳实践

### ✅ 推荐做法

1. **使用模板快速开始**
   - 选择最接近的模板
   - 在其基础上调整
   - 节省时间

2. **批量编辑相关操作**
   - 一次完成相关编辑
   - 减少多次操作
   - 提高效率

3. **定期优化结构**
   - 每月审查一次分类
   - 合并冗余分类
   - 保持清晰结构

4. **参考编辑建议**
   - 系统自动检测问题
   - 用户可自主选择
   - 逐步改进

### ❌ 避免做法

1. 频繁重命名（会导致混乱）
2. 过度拆分（分类过多）
3. 不一致的命名规范
4. 手动修改分类映射

## 性能指标

| 操作 | 时间 | 说明 |
|------|------|------|
| 重命名 | <5ms | 快速 |
| 合并（10个） | <10ms | 可接受 |
| 拆分（100个） | <50ms | 合理 |
| 批量编辑（5个） | <50ms | 高效 |
| 应用到结果（1000个） | 100-200ms | 后台操作 |

## 常见问题

**Q: 编辑会丢失吗？**
A: 编辑历史保存在内存中。刷新页面后丢失（未来支持持久化）。

**Q: 可以撤销吗？**
A: 支持撤销最后一次编辑。未来支持完整的撤销/重做栈。

**Q: 能导出配置吗？**
A: 可以。调用 `exportEditConfig()` 得到完整配置，可用于备份。

**Q: 相似度阈值是多少？**
A: 默认 0.7（70% 相似度）。可根据需要调整。

**Q: 支持模板自定义吗？**
A: 当前版本内置 6 个模板。未来支持用户自定义模板。

## 未来增强

### 计划中的功能

1. **编辑历史面板**
   - 可视化显示所有编辑
   - 支持选择性撤销

2. **自定义模板保存**
   - 保存个人的分类结构
   - 快速应用到新分析

3. **分类预设库**
   - 共享高质量的分类结构
   - 社区贡献

4. **高级匹配**
   - 智能检测可合并的分类
   - 建议最佳分类结构

5. **分类统计**
   - 显示编辑前后的对比
   - 可视化分类结构变化

## 版本信息

- **版本号:** 1.0.0
- **发布日期:** 2024年10月
- **最后更新:** 2024年10月

---

## 相关文档

- [用户反馈学习系统说明](./用户反馈学习系统说明.md)
- [书签同步功能说明](./书签同步功能说明.md)
- [智能分类系统技术文档](./智能分类系统技术文档.md)

**✏️ 灵活编辑，打造个性化的分类体系！**
