<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI功能测试 - 书签助手</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: white;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .title {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 16px;
    }

    .subtitle {
      font-size: 16px;
      opacity: 0.9;
    }

    .test-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .test-card {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 24px;
    }

    .test-card h3 {
      font-size: 18px;
      margin-bottom: 12px;
      color: white;
    }

    .test-card p {
      font-size: 14px;
      margin-bottom: 16px;
      opacity: 0.9;
    }

    .btn {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      padding: 8px 16px;
      color: white;
      text-decoration: none;
      display: inline-block;
      margin: 4px 8px 4px 0;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    .btn-primary {
      background: linear-gradient(135deg, #007aff 0%, #5856d6 100%);
      border: none;
    }

    .status-panel {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }

    .status-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .status-item:last-child {
      border-bottom: none;
    }

    .log-area {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 16px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 20px;
    }

    .log-entry {
      margin-bottom: 4px;
      word-wrap: break-word;
    }

    .log-info { color: #64b5f6; }
    .log-success { color: #4ade80; }
    .log-warning { color: #fbbf24; }
    .log-error { color: #f87171; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 class="title">🧪 AI功能测试中心</h1>
      <p class="subtitle">测试和验证AI智能分析中心的各项功能</p>
    </div>

    <div class="test-grid">
      <div class="test-card">
        <h3>🤖 AI分析中心</h3>
        <p>测试AI智能分析的核心功能</p>
        <button class="btn btn-primary" onclick="testAnalysisCenter()">打开分析中心</button>
        <button class="btn" onclick="testQuickAnalysis()">快速分析</button>
      </div>

      <div class="test-card">
        <h3>📚 书签管理器</h3>
        <p>测试增强型书签管理功能</p>
        <button class="btn btn-primary" onclick="testBookmarkManager()">打开管理器</button>
        <button class="btn" onclick="testCreateFolder()">创建文件夹</button>
      </div>

      <div class="test-card">
        <h3>🔍 问题检测</h3>
        <p>测试重复书签和失效链接检测</p>
        <button class="btn btn-primary" onclick="testDetection()">开始检测</button>
        <button class="btn" onclick="testDuplicates()">检测重复</button>
      </div>

      <div class="test-card">
        <h3>📊 数据可视化</h3>
        <p>测试图表和可视化功能</p>
        <button class="btn btn-primary" onclick="testVisualization()">生成图表</button>
        <button class="btn" onclick="testWordCloud()">词云</button>
      </div>

      <div class="test-card">
        <h3>💾 数据管理</h3>
        <p>测试导入导出和备份功能</p>
        <button class="btn btn-primary" onclick="testDataManagement()">数据中心</button>
        <button class="btn" onclick="testBackup()">创建备份</button>
      </div>

      <div class="test-card">
        <h3>⚙️ 系统设置</h3>
        <p>测试API配置和系统设置</p>
        <button class="btn btn-primary" onclick="testSettings()">打开设置</button>
        <button class="btn" onclick="testApiConnection()">测试API</button>
      </div>
    </div>

    <div class="status-panel">
      <h3>📈 系统状态</h3>
      <div class="status-item">
        <span>📚 书签数量:</span>
        <span id="bookmark-count">-</span>
      </div>
      <div class="status-item">
        <span>🤖 API状态:</span>
        <span id="api-status">检查中...</span>
      </div>
      <div class="status-item">
        <span>🧠 分析状态:</span>
        <span id="analysis-status">待开始</span>
      </div>
      <div class="status-item">
        <span>⏰ 最后更新:</span>
        <span id="last-update">-</span>
      </div>
    </div>

    <div class="log-area" id="log-area">
      <div class="log-entry log-info">[系统] AI功能测试中心已启动</div>
    </div>
  </div>

  <script type="module">
    // 导入模块（如果在扩展环境中）
    let services = {};
    
    try {
      if (typeof chrome !== 'undefined' && chrome.runtime) {
        // 扩展环境
        const { ApiService } = await import('./modules/apiService.js');
        const { BookmarkService } = await import('./modules/bookmarkService.js');
        const { DetectionService } = await import('./modules/detectionService.js');
        
        services.apiService = new ApiService();
        services.bookmarkService = new BookmarkService();
        services.detectionService = new DetectionService();
        
        // 设置日志回调
        services.apiService.setLogCallback(addLog);
        services.bookmarkService.setLogCallback(addLog);
        services.detectionService.setLogCallback(addLog);
      }
    } catch (error) {
      addLog('模块导入失败: ' + error.message, 'error');
    }

    // 日志函数
    function addLog(message, type = 'info') {
      const logArea = document.getElementById('log-area');
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry log-${type}`;
      logEntry.textContent = `[${timestamp}] ${message}`;
      
      logArea.appendChild(logEntry);
      logArea.scrollTop = logArea.scrollHeight;
      
      // 限制日志数量
      while (logArea.children.length > 100) {
        logArea.removeChild(logArea.firstChild);
      }
    }

    // 更新状态
    function updateStatus(key, value) {
      const element = document.getElementById(key);
      if (element) {
        element.textContent = value;
      }
    }

    // 测试函数
    window.testAnalysisCenter = function() {
      addLog('🧠 打开AI分析中心...', 'info');
      try {
        if (typeof chrome !== 'undefined' && chrome.tabs) {
          chrome.tabs.create({ url: chrome.runtime.getURL('ai-analysis-center.html') });
        } else {
          window.open('ai-analysis-center.html', '_blank');
        }
        addLog('✅ AI分析中心已打开', 'success');
      } catch (error) {
        addLog('❌ 打开失败: ' + error.message, 'error');
      }
    };

    window.testQuickAnalysis = async function() {
      addLog('⚡ 开始快速分析测试...', 'info');
      updateStatus('analysis-status', '分析中...');
      
      try {
        if (services.apiService && services.bookmarkService) {
          const apiStatus = await services.apiService.checkApiStatus();
          addLog(`API状态: ${apiStatus.connected ? '已连接' : '未连接'}`, apiStatus.connected ? 'success' : 'warning');
          
          if (apiStatus.connected) {
            const bookmarks = await services.bookmarkService.getAllBookmarks();
            addLog(`获取到 ${bookmarks.length} 个书签`, 'info');
            updateStatus('bookmark-count', bookmarks.length);
          }
        } else {
          addLog('⚠️ 服务未初始化，使用模拟数据', 'warning');
        }
        
        updateStatus('analysis-status', '测试完成');
        addLog('✅ 快速分析测试完成', 'success');
      } catch (error) {
        addLog('❌ 分析测试失败: ' + error.message, 'error');
        updateStatus('analysis-status', '测试失败');
      }
    };

    window.testBookmarkManager = function() {
      addLog('📚 打开书签管理器...', 'info');
      try {
        if (typeof chrome !== 'undefined' && chrome.tabs) {
          chrome.tabs.create({ url: chrome.runtime.getURL('enhanced-bookmark-manager.html') });
        } else {
          window.open('enhanced-bookmark-manager.html', '_blank');
        }
        addLog('✅ 书签管理器已打开', 'success');
      } catch (error) {
        addLog('❌ 打开失败: ' + error.message, 'error');
      }
    };

    window.testCreateFolder = async function() {
      addLog('📁 测试创建文件夹...', 'info');
      
      const folderName = `测试文件夹_${Date.now()}`;
      
      try {
        if (typeof chrome !== 'undefined' && chrome.bookmarks) {
          await new Promise((resolve, reject) => {
            chrome.bookmarks.create({
              parentId: '1',
              title: folderName
            }, (result) => {
              if (chrome.runtime.lastError) {
                reject(new Error(chrome.runtime.lastError.message));
              } else {
                resolve(result);
              }
            });
          });
          
          addLog(`✅ 文件夹"${folderName}"创建成功`, 'success');
        } else {
          addLog('⚠️ 非扩展环境，无法创建实际文件夹', 'warning');
        }
      } catch (error) {
        addLog('❌ 创建文件夹失败: ' + error.message, 'error');
      }
    };

    window.testDetection = async function() {
      addLog('🔍 开始问题检测测试...', 'info');
      
      try {
        if (services.detectionService) {
          const result = await services.detectionService.detectDuplicateBookmarks();
          addLog(`检测到 ${result.urlDuplicateCount} 个重复URL`, 'info');
        } else {
          addLog('⚠️ 检测服务未初始化，使用模拟结果', 'warning');
        }
        
        addLog('✅ 问题检测测试完成', 'success');
      } catch (error) {
        addLog('❌ 检测测试失败: ' + error.message, 'error');
      }
    };

    window.testDuplicates = async function() {
      addLog('👥 测试重复书签检测...', 'info');
      
      // 这里可以添加具体的重复检测逻辑
      setTimeout(() => {
        addLog('✅ 重复检测模拟完成', 'success');
      }, 1000);
    };

    window.testVisualization = function() {
      addLog('📊 打开数据可视化...', 'info');
      try {
        const url = 'ai-analysis-center.html?tab=visualization';
        if (typeof chrome !== 'undefined' && chrome.tabs) {
          chrome.tabs.create({ url: chrome.runtime.getURL(url) });
        } else {
          window.open(url, '_blank');
        }
        addLog('✅ 可视化页面已打开', 'success');
      } catch (error) {
        addLog('❌ 打开失败: ' + error.message, 'error');
      }
    };

    window.testWordCloud = function() {
      addLog('☁️ 测试词云生成...', 'info');
      
      // 模拟词云生成
      setTimeout(() => {
        addLog('✅ 词云生成模拟完成', 'success');
      }, 500);
    };

    window.testDataManagement = function() {
      addLog('💾 打开数据管理中心...', 'info');
      try {
        const url = 'ai-analysis-center.html?tab=data';
        if (typeof chrome !== 'undefined' && chrome.tabs) {
          chrome.tabs.create({ url: chrome.runtime.getURL(url) });
        } else {
          window.open(url, '_blank');
        }
        addLog('✅ 数据管理中心已打开', 'success');
      } catch (error) {
        addLog('❌ 打开失败: ' + error.message, 'error');
      }
    };

    window.testBackup = async function() {
      addLog('💾 测试备份功能...', 'info');
      
      try {
        const backupData = {
          timestamp: new Date().toISOString(),
          version: '1.0',
          testData: '这是测试备份'
        };
        
        const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `测试备份_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        addLog('✅ 测试备份文件已下载', 'success');
      } catch (error) {
        addLog('❌ 备份测试失败: ' + error.message, 'error');
      }
    };

    window.testSettings = function() {
      addLog('⚙️ 打开系统设置...', 'info');
      try {
        if (typeof chrome !== 'undefined' && chrome.tabs) {
          chrome.tabs.create({ url: chrome.runtime.getURL('options.html') });
        } else {
          window.open('options.html', '_blank');
        }
        addLog('✅ 设置页面已打开', 'success');
      } catch (error) {
        addLog('❌ 打开失败: ' + error.message, 'error');
      }
    };

    window.testApiConnection = async function() {
      addLog('🧪 测试API连接...', 'info');
      updateStatus('api-status', '测试中...');
      
      try {
        if (services.apiService) {
          const status = await services.apiService.checkApiStatus();
          const statusText = status.connected ? `✅ ${status.provider}` : '❌ 未配置';
          updateStatus('api-status', statusText);
          addLog(`API状态: ${statusText}`, status.connected ? 'success' : 'warning');
        } else {
          updateStatus('api-status', '⚠️ 服务未初始化');
          addLog('⚠️ API服务未初始化', 'warning');
        }
      } catch (error) {
        updateStatus('api-status', '❌ 测试失败');
        addLog('❌ API测试失败: ' + error.message, 'error');
      }
    };

    // 初始化
    document.addEventListener('DOMContentLoaded', async () => {
      addLog('🚀 AI功能测试中心初始化完成', 'success');
      updateStatus('last-update', new Date().toLocaleTimeString());
      
      // 自动检测API状态
      if (services.apiService) {
        setTimeout(testApiConnection, 1000);
      }
      
      // 自动检测书签数量
      if (services.bookmarkService) {
        setTimeout(testQuickAnalysis, 2000);
      }
    });
  </script>
</body>
</html>