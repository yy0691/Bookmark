<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIåŠŸèƒ½æµ‹è¯• - ä¹¦ç­¾åŠ©æ‰‹</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: white;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .title {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 16px;
    }

    .subtitle {
      font-size: 16px;
      opacity: 0.9;
    }

    .test-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .test-card {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 24px;
    }

    .test-card h3 {
      font-size: 18px;
      margin-bottom: 12px;
      color: white;
    }

    .test-card p {
      font-size: 14px;
      margin-bottom: 16px;
      opacity: 0.9;
    }

    .btn {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      padding: 8px 16px;
      color: white;
      text-decoration: none;
      display: inline-block;
      margin: 4px 8px 4px 0;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    .btn-primary {
      background: linear-gradient(135deg, #007aff 0%, #5856d6 100%);
      border: none;
    }

    .status-panel {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }

    .status-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .status-item:last-child {
      border-bottom: none;
    }

    .log-area {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 16px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 20px;
    }

    .log-entry {
      margin-bottom: 4px;
      word-wrap: break-word;
    }

    .log-info { color: #64b5f6; }
    .log-success { color: #4ade80; }
    .log-warning { color: #fbbf24; }
    .log-error { color: #f87171; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 class="title">ğŸ§ª AIåŠŸèƒ½æµ‹è¯•ä¸­å¿ƒ</h1>
      <p class="subtitle">æµ‹è¯•å’ŒéªŒè¯AIæ™ºèƒ½åˆ†æä¸­å¿ƒçš„å„é¡¹åŠŸèƒ½</p>
    </div>

    <div class="test-grid">
      <div class="test-card">
        <h3>ğŸ¤– AIåˆ†æä¸­å¿ƒ</h3>
        <p>æµ‹è¯•AIæ™ºèƒ½åˆ†æçš„æ ¸å¿ƒåŠŸèƒ½</p>
        <button class="btn btn-primary" onclick="testAnalysisCenter()">æ‰“å¼€åˆ†æä¸­å¿ƒ</button>
        <button class="btn" onclick="testQuickAnalysis()">å¿«é€Ÿåˆ†æ</button>
      </div>

      <div class="test-card">
        <h3>ğŸ“š ä¹¦ç­¾ç®¡ç†å™¨</h3>
        <p>æµ‹è¯•å¢å¼ºå‹ä¹¦ç­¾ç®¡ç†åŠŸèƒ½</p>
        <button class="btn btn-primary" onclick="testBookmarkManager()">æ‰“å¼€ç®¡ç†å™¨</button>
        <button class="btn" onclick="testCreateFolder()">åˆ›å»ºæ–‡ä»¶å¤¹</button>
      </div>

      <div class="test-card">
        <h3>ğŸ” é—®é¢˜æ£€æµ‹</h3>
        <p>æµ‹è¯•é‡å¤ä¹¦ç­¾å’Œå¤±æ•ˆé“¾æ¥æ£€æµ‹</p>
        <button class="btn btn-primary" onclick="testDetection()">å¼€å§‹æ£€æµ‹</button>
        <button class="btn" onclick="testDuplicates()">æ£€æµ‹é‡å¤</button>
      </div>

      <div class="test-card">
        <h3>ğŸ“Š æ•°æ®å¯è§†åŒ–</h3>
        <p>æµ‹è¯•å›¾è¡¨å’Œå¯è§†åŒ–åŠŸèƒ½</p>
        <button class="btn btn-primary" onclick="testVisualization()">ç”Ÿæˆå›¾è¡¨</button>
        <button class="btn" onclick="testWordCloud()">è¯äº‘</button>
      </div>

      <div class="test-card">
        <h3>ğŸ’¾ æ•°æ®ç®¡ç†</h3>
        <p>æµ‹è¯•å¯¼å…¥å¯¼å‡ºå’Œå¤‡ä»½åŠŸèƒ½</p>
        <button class="btn btn-primary" onclick="testDataManagement()">æ•°æ®ä¸­å¿ƒ</button>
        <button class="btn" onclick="testBackup()">åˆ›å»ºå¤‡ä»½</button>
      </div>

      <div class="test-card">
        <h3>âš™ï¸ ç³»ç»Ÿè®¾ç½®</h3>
        <p>æµ‹è¯•APIé…ç½®å’Œç³»ç»Ÿè®¾ç½®</p>
        <button class="btn btn-primary" onclick="testSettings()">æ‰“å¼€è®¾ç½®</button>
        <button class="btn" onclick="testApiConnection()">æµ‹è¯•API</button>
      </div>
    </div>

    <div class="status-panel">
      <h3>ğŸ“ˆ ç³»ç»ŸçŠ¶æ€</h3>
      <div class="status-item">
        <span>ğŸ“š ä¹¦ç­¾æ•°é‡:</span>
        <span id="bookmark-count">-</span>
      </div>
      <div class="status-item">
        <span>ğŸ¤– APIçŠ¶æ€:</span>
        <span id="api-status">æ£€æŸ¥ä¸­...</span>
      </div>
      <div class="status-item">
        <span>ğŸ§  åˆ†æçŠ¶æ€:</span>
        <span id="analysis-status">å¾…å¼€å§‹</span>
      </div>
      <div class="status-item">
        <span>â° æœ€åæ›´æ–°:</span>
        <span id="last-update">-</span>
      </div>
    </div>

    <div class="log-area" id="log-area">
      <div class="log-entry log-info">[ç³»ç»Ÿ] AIåŠŸèƒ½æµ‹è¯•ä¸­å¿ƒå·²å¯åŠ¨</div>
    </div>
  </div>

  <script type="module">
    // å¯¼å…¥æ¨¡å—ï¼ˆå¦‚æœåœ¨æ‰©å±•ç¯å¢ƒä¸­ï¼‰
    let services = {};
    
    try {
      if (typeof chrome !== 'undefined' && chrome.runtime) {
        // æ‰©å±•ç¯å¢ƒ
        const { ApiService } = await import('./modules/apiService.js');
        const { BookmarkService } = await import('./modules/bookmarkService.js');
        const { DetectionService } = await import('./modules/detectionService.js');
        
        services.apiService = new ApiService();
        services.bookmarkService = new BookmarkService();
        services.detectionService = new DetectionService();
        
        // è®¾ç½®æ—¥å¿—å›è°ƒ
        services.apiService.setLogCallback(addLog);
        services.bookmarkService.setLogCallback(addLog);
        services.detectionService.setLogCallback(addLog);
      }
    } catch (error) {
      addLog('æ¨¡å—å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
    }

    // æ—¥å¿—å‡½æ•°
    function addLog(message, type = 'info') {
      const logArea = document.getElementById('log-area');
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry log-${type}`;
      logEntry.textContent = `[${timestamp}] ${message}`;
      
      logArea.appendChild(logEntry);
      logArea.scrollTop = logArea.scrollHeight;
      
      // é™åˆ¶æ—¥å¿—æ•°é‡
      while (logArea.children.length > 100) {
        logArea.removeChild(logArea.firstChild);
      }
    }

    // æ›´æ–°çŠ¶æ€
    function updateStatus(key, value) {
      const element = document.getElementById(key);
      if (element) {
        element.textContent = value;
      }
    }

    // æµ‹è¯•å‡½æ•°
    window.testAnalysisCenter = function() {
      addLog('ğŸ§  æ‰“å¼€AIåˆ†æä¸­å¿ƒ...', 'info');
      try {
        if (typeof chrome !== 'undefined' && chrome.tabs) {
          chrome.tabs.create({ url: chrome.runtime.getURL('ai-analysis-center.html') });
        } else {
          window.open('ai-analysis-center.html', '_blank');
        }
        addLog('âœ… AIåˆ†æä¸­å¿ƒå·²æ‰“å¼€', 'success');
      } catch (error) {
        addLog('âŒ æ‰“å¼€å¤±è´¥: ' + error.message, 'error');
      }
    };

    window.testQuickAnalysis = async function() {
      addLog('âš¡ å¼€å§‹å¿«é€Ÿåˆ†ææµ‹è¯•...', 'info');
      updateStatus('analysis-status', 'åˆ†æä¸­...');
      
      try {
        if (services.apiService && services.bookmarkService) {
          const apiStatus = await services.apiService.checkApiStatus();
          addLog(`APIçŠ¶æ€: ${apiStatus.connected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}`, apiStatus.connected ? 'success' : 'warning');
          
          if (apiStatus.connected) {
            const bookmarks = await services.bookmarkService.getAllBookmarks();
            addLog(`è·å–åˆ° ${bookmarks.length} ä¸ªä¹¦ç­¾`, 'info');
            updateStatus('bookmark-count', bookmarks.length);
          }
        } else {
          addLog('âš ï¸ æœåŠ¡æœªåˆå§‹åŒ–ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®', 'warning');
        }
        
        updateStatus('analysis-status', 'æµ‹è¯•å®Œæˆ');
        addLog('âœ… å¿«é€Ÿåˆ†ææµ‹è¯•å®Œæˆ', 'success');
      } catch (error) {
        addLog('âŒ åˆ†ææµ‹è¯•å¤±è´¥: ' + error.message, 'error');
        updateStatus('analysis-status', 'æµ‹è¯•å¤±è´¥');
      }
    };

    window.testBookmarkManager = function() {
      addLog('ğŸ“š æ‰“å¼€ä¹¦ç­¾ç®¡ç†å™¨...', 'info');
      try {
        if (typeof chrome !== 'undefined' && chrome.tabs) {
          chrome.tabs.create({ url: chrome.runtime.getURL('enhanced-bookmark-manager.html') });
        } else {
          window.open('enhanced-bookmark-manager.html', '_blank');
        }
        addLog('âœ… ä¹¦ç­¾ç®¡ç†å™¨å·²æ‰“å¼€', 'success');
      } catch (error) {
        addLog('âŒ æ‰“å¼€å¤±è´¥: ' + error.message, 'error');
      }
    };

    window.testCreateFolder = async function() {
      addLog('ğŸ“ æµ‹è¯•åˆ›å»ºæ–‡ä»¶å¤¹...', 'info');
      
      const folderName = `æµ‹è¯•æ–‡ä»¶å¤¹_${Date.now()}`;
      
      try {
        if (typeof chrome !== 'undefined' && chrome.bookmarks) {
          await new Promise((resolve, reject) => {
            chrome.bookmarks.create({
              parentId: '1',
              title: folderName
            }, (result) => {
              if (chrome.runtime.lastError) {
                reject(new Error(chrome.runtime.lastError.message));
              } else {
                resolve(result);
              }
            });
          });
          
          addLog(`âœ… æ–‡ä»¶å¤¹"${folderName}"åˆ›å»ºæˆåŠŸ`, 'success');
        } else {
          addLog('âš ï¸ éæ‰©å±•ç¯å¢ƒï¼Œæ— æ³•åˆ›å»ºå®é™…æ–‡ä»¶å¤¹', 'warning');
        }
      } catch (error) {
        addLog('âŒ åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥: ' + error.message, 'error');
      }
    };

    window.testDetection = async function() {
      addLog('ğŸ” å¼€å§‹é—®é¢˜æ£€æµ‹æµ‹è¯•...', 'info');
      
      try {
        if (services.detectionService) {
          const result = await services.detectionService.detectDuplicateBookmarks();
          addLog(`æ£€æµ‹åˆ° ${result.urlDuplicateCount} ä¸ªé‡å¤URL`, 'info');
        } else {
          addLog('âš ï¸ æ£€æµ‹æœåŠ¡æœªåˆå§‹åŒ–ï¼Œä½¿ç”¨æ¨¡æ‹Ÿç»“æœ', 'warning');
        }
        
        addLog('âœ… é—®é¢˜æ£€æµ‹æµ‹è¯•å®Œæˆ', 'success');
      } catch (error) {
        addLog('âŒ æ£€æµ‹æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
      }
    };

    window.testDuplicates = async function() {
      addLog('ğŸ‘¥ æµ‹è¯•é‡å¤ä¹¦ç­¾æ£€æµ‹...', 'info');
      
      // è¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„é‡å¤æ£€æµ‹é€»è¾‘
      setTimeout(() => {
        addLog('âœ… é‡å¤æ£€æµ‹æ¨¡æ‹Ÿå®Œæˆ', 'success');
      }, 1000);
    };

    window.testVisualization = function() {
      addLog('ğŸ“Š æ‰“å¼€æ•°æ®å¯è§†åŒ–...', 'info');
      try {
        const url = 'ai-analysis-center.html?tab=visualization';
        if (typeof chrome !== 'undefined' && chrome.tabs) {
          chrome.tabs.create({ url: chrome.runtime.getURL(url) });
        } else {
          window.open(url, '_blank');
        }
        addLog('âœ… å¯è§†åŒ–é¡µé¢å·²æ‰“å¼€', 'success');
      } catch (error) {
        addLog('âŒ æ‰“å¼€å¤±è´¥: ' + error.message, 'error');
      }
    };

    window.testWordCloud = function() {
      addLog('â˜ï¸ æµ‹è¯•è¯äº‘ç”Ÿæˆ...', 'info');
      
      // æ¨¡æ‹Ÿè¯äº‘ç”Ÿæˆ
      setTimeout(() => {
        addLog('âœ… è¯äº‘ç”Ÿæˆæ¨¡æ‹Ÿå®Œæˆ', 'success');
      }, 500);
    };

    window.testDataManagement = function() {
      addLog('ğŸ’¾ æ‰“å¼€æ•°æ®ç®¡ç†ä¸­å¿ƒ...', 'info');
      try {
        const url = 'ai-analysis-center.html?tab=data';
        if (typeof chrome !== 'undefined' && chrome.tabs) {
          chrome.tabs.create({ url: chrome.runtime.getURL(url) });
        } else {
          window.open(url, '_blank');
        }
        addLog('âœ… æ•°æ®ç®¡ç†ä¸­å¿ƒå·²æ‰“å¼€', 'success');
      } catch (error) {
        addLog('âŒ æ‰“å¼€å¤±è´¥: ' + error.message, 'error');
      }
    };

    window.testBackup = async function() {
      addLog('ğŸ’¾ æµ‹è¯•å¤‡ä»½åŠŸèƒ½...', 'info');
      
      try {
        const backupData = {
          timestamp: new Date().toISOString(),
          version: '1.0',
          testData: 'è¿™æ˜¯æµ‹è¯•å¤‡ä»½'
        };
        
        const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `æµ‹è¯•å¤‡ä»½_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        addLog('âœ… æµ‹è¯•å¤‡ä»½æ–‡ä»¶å·²ä¸‹è½½', 'success');
      } catch (error) {
        addLog('âŒ å¤‡ä»½æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
      }
    };

    window.testSettings = function() {
      addLog('âš™ï¸ æ‰“å¼€ç³»ç»Ÿè®¾ç½®...', 'info');
      try {
        if (typeof chrome !== 'undefined' && chrome.tabs) {
          chrome.tabs.create({ url: chrome.runtime.getURL('options.html') });
        } else {
          window.open('options.html', '_blank');
        }
        addLog('âœ… è®¾ç½®é¡µé¢å·²æ‰“å¼€', 'success');
      } catch (error) {
        addLog('âŒ æ‰“å¼€å¤±è´¥: ' + error.message, 'error');
      }
    };

    window.testApiConnection = async function() {
      addLog('ğŸ§ª æµ‹è¯•APIè¿æ¥...', 'info');
      updateStatus('api-status', 'æµ‹è¯•ä¸­...');
      
      try {
        if (services.apiService) {
          const status = await services.apiService.checkApiStatus();
          const statusText = status.connected ? `âœ… ${status.provider}` : 'âŒ æœªé…ç½®';
          updateStatus('api-status', statusText);
          addLog(`APIçŠ¶æ€: ${statusText}`, status.connected ? 'success' : 'warning');
        } else {
          updateStatus('api-status', 'âš ï¸ æœåŠ¡æœªåˆå§‹åŒ–');
          addLog('âš ï¸ APIæœåŠ¡æœªåˆå§‹åŒ–', 'warning');
        }
      } catch (error) {
        updateStatus('api-status', 'âŒ æµ‹è¯•å¤±è´¥');
        addLog('âŒ APIæµ‹è¯•å¤±è´¥: ' + error.message, 'error');
      }
    };

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async () => {
      addLog('ğŸš€ AIåŠŸèƒ½æµ‹è¯•ä¸­å¿ƒåˆå§‹åŒ–å®Œæˆ', 'success');
      updateStatus('last-update', new Date().toLocaleTimeString());
      
      // è‡ªåŠ¨æ£€æµ‹APIçŠ¶æ€
      if (services.apiService) {
        setTimeout(testApiConnection, 1000);
      }
      
      // è‡ªåŠ¨æ£€æµ‹ä¹¦ç­¾æ•°é‡
      if (services.bookmarkService) {
        setTimeout(testQuickAnalysis, 2000);
      }
    });
  </script>
</body>
</html>