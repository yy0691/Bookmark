<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>修复测试页面</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
      min-height: 100vh;
      padding: 20px;
      color: #1d1d1f;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
    }
    
    .test-section {
      margin-bottom: 24px;
      padding: 16px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .test-button {
      background: linear-gradient(135deg, #007aff 0%, #5856d6 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin: 8px;
      transition: all 0.2s ease;
    }
    
    .test-button:hover {
      background: linear-gradient(135deg, #0056b3 0%, #4a4bb8 100%);
      transform: translateY(-1px);
    }
    
    .status {
      margin-top: 12px;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .status.success {
      background: rgba(48, 209, 88, 0.2);
      color: #30d158;
      border: 1px solid rgba(48, 209, 88, 0.3);
    }
    
    .status.error {
      background: rgba(255, 59, 48, 0.2);
      color: #ff3b30;
      border: 1px solid rgba(255, 59, 48, 0.3);
    }
    
    .status.info {
      background: rgba(0, 122, 255, 0.2);
      color: #007aff;
      border: 1px solid rgba(0, 122, 255, 0.3);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🔧 修复测试页面</h1>
    
    <div class="test-section">
      <h3>1. CSP策略测试</h3>
      <p>测试Content Security Policy是否允许外部脚本和内联脚本</p>
      <button class="test-button" onclick="testCSP()">测试CSP</button>
      <div id="csp-status" class="status info">等待测试...</div>
    </div>
    
    <div class="test-section">
      <h3>2. 事件监听器测试</h3>
      <p>测试按钮事件监听器是否正常工作</p>
      <button class="test-button" id="event-test-btn">测试事件监听</button>
      <div id="event-status" class="status info">等待测试...</div>
    </div>
    
    <div class="test-section">
      <h3>3. API状态检查</h3>
      <p>测试API状态检查功能</p>
      <button class="test-button" onclick="testApiStatus()">检查API状态</button>
      <div id="api-status" class="status info">等待测试...</div>
    </div>
    
    <div class="test-section">
      <h3>4. JSON解析测试</h3>
      <p>测试改进的JSON解析功能</p>
      <button class="test-button" onclick="testJsonParsing()">测试JSON解析</button>
      <div id="json-status" class="status info">等待测试...</div>
    </div>
    
    <div class="test-section">
      <h3>5. 设置按钮测试</h3>
      <p>测试设置按钮是否正常工作</p>
      <button class="test-button" onclick="testSetupButton()">测试设置按钮</button>
      <div id="setup-status" class="status info">等待测试...</div>
    </div>
    
    <div class="test-section">
      <h3>6. 外部库加载测试</h3>
      <p>测试Chart.js和D3.js是否正常加载</p>
      <button class="test-button" onclick="testExternalLibraries()">测试外部库</button>
      <div id="library-status" class="status info">等待测试...</div>
    </div>
  </div>

  <script>
    // 测试CSP策略
    function testCSP() {
      const status = document.getElementById('csp-status');
      try {
        // 测试内联脚本执行
        const testResult = 'CSP测试通过';
        status.textContent = testResult;
        status.className = 'status success';
        console.log('CSP测试通过');
      } catch (error) {
        status.textContent = `CSP测试失败: ${error.message}`;
        status.className = 'status error';
        console.error('CSP测试失败:', error);
      }
    }
    
    // 测试事件监听器
    document.addEventListener('DOMContentLoaded', function() {
      const eventBtn = document.getElementById('event-test-btn');
      const eventStatus = document.getElementById('event-status');
      
      if (eventBtn) {
        eventBtn.addEventListener('click', function() {
          eventStatus.textContent = '事件监听器工作正常！';
          eventStatus.className = 'status success';
          console.log('事件监听器测试通过');
        });
        eventStatus.textContent = '事件监听器已设置，请点击按钮测试';
        eventStatus.className = 'status info';
      } else {
        eventStatus.textContent = '无法找到测试按钮元素';
        eventStatus.className = 'status error';
      }
    });
    
    // 测试API状态检查
    function testApiStatus() {
      const status = document.getElementById('api-status');
      try {
        if (typeof chrome !== 'undefined' && chrome.storage) {
          chrome.storage.sync.get(['apiProvider', 'apiKey'], (result) => {
            if (result.apiProvider && result.apiKey) {
              status.textContent = `API已配置: ${result.apiProvider}`;
              status.className = 'status success';
            } else {
              status.textContent = 'API未配置，请先在设置中配置API';
              status.className = 'status error';
            }
          });
        } else {
          status.textContent = 'Chrome扩展API不可用';
          status.className = 'status error';
        }
      } catch (error) {
        status.textContent = `API状态检查失败: ${error.message}`;
        status.className = 'status error';
      }
    }
    
    // 测试JSON解析
    function testJsonParsing() {
      const status = document.getElementById('json-status');
      try {
        // 模拟有问题的JSON
        const badJson = `{
          "技术": [
            {"title": "GitHub", "url": "https://github.com"},
            {"title": "Stack Overflow", "url": "https://stackoverflow.com"}
          ],
          "娱乐": [
            {"title": "YouTube", "url": "https://youtube.com"}
          ]
        `; // 故意缺少闭合括号
        
        // 使用改进的解析函数（如果存在）
        if (typeof parseJsonWithRecovery === 'function') {
          const result = parseJsonWithRecovery(badJson);
          status.textContent = `JSON解析成功，找到 ${Object.keys(result).length} 个分类`;
          status.className = 'status success';
        } else {
          // 使用标准JSON.parse
          const result = JSON.parse(badJson + '}'); // 手动修复
          status.textContent = `标准JSON解析成功，找到 ${Object.keys(result).length} 个分类`;
          status.className = 'status success';
        }
      } catch (error) {
        status.textContent = `JSON解析失败: ${error.message}`;
        status.className = 'status error';
      }
    }
    
    // 测试设置按钮
    function testSetupButton() {
      const status = document.getElementById('setup-status');
      try {
        if (typeof chrome !== 'undefined' && chrome.runtime) {
          chrome.runtime.openOptionsPage();
          status.textContent = '设置页面已打开';
          status.className = 'status success';
        } else {
          status.textContent = 'Chrome扩展API不可用';
          status.className = 'status error';
        }
      } catch (error) {
        status.textContent = `设置按钮测试失败: ${error.message}`;
        status.className = 'status error';
      }
    }
    
    // 测试外部库加载
    function testExternalLibraries() {
      const status = document.getElementById('library-status');
      const results = [];
      
      if (typeof Chart !== 'undefined') {
        results.push('Chart.js ✓');
      } else {
        results.push('Chart.js ✗');
      }
      
      if (typeof d3 !== 'undefined') {
        results.push('D3.js ✓');
      } else {
        results.push('D3.js ✗');
      }
      
      if (results.every(r => r.includes('✓'))) {
        status.textContent = `所有外部库加载成功: ${results.join(', ')}`;
        status.className = 'status success';
      } else {
        status.textContent = `部分库加载失败: ${results.join(', ')}`;
        status.className = 'status error';
      }
    }
    
    // 页面加载完成后的初始化
    document.addEventListener('DOMContentLoaded', function() {
      console.log('测试页面加载完成');
      
      // 自动运行一些基本测试
      setTimeout(() => {
        testCSP();
        testExternalLibraries();
      }, 1000);
    });
  </script>
</body>
</html> 