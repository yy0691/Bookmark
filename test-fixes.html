<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¿®å¤æµ‹è¯•é¡µé¢</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
      min-height: 100vh;
      padding: 20px;
      color: #1d1d1f;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
    }
    
    .test-section {
      margin-bottom: 24px;
      padding: 16px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .test-button {
      background: linear-gradient(135deg, #007aff 0%, #5856d6 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin: 8px;
      transition: all 0.2s ease;
    }
    
    .test-button:hover {
      background: linear-gradient(135deg, #0056b3 0%, #4a4bb8 100%);
      transform: translateY(-1px);
    }
    
    .status {
      margin-top: 12px;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .status.success {
      background: rgba(48, 209, 88, 0.2);
      color: #30d158;
      border: 1px solid rgba(48, 209, 88, 0.3);
    }
    
    .status.error {
      background: rgba(255, 59, 48, 0.2);
      color: #ff3b30;
      border: 1px solid rgba(255, 59, 48, 0.3);
    }
    
    .status.info {
      background: rgba(0, 122, 255, 0.2);
      color: #007aff;
      border: 1px solid rgba(0, 122, 255, 0.3);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ ä¿®å¤æµ‹è¯•é¡µé¢</h1>
    
    <div class="test-section">
      <h3>1. CSPç­–ç•¥æµ‹è¯•</h3>
      <p>æµ‹è¯•Content Security Policyæ˜¯å¦å…è®¸å¤–éƒ¨è„šæœ¬å’Œå†…è”è„šæœ¬</p>
      <button class="test-button" onclick="testCSP()">æµ‹è¯•CSP</button>
      <div id="csp-status" class="status info">ç­‰å¾…æµ‹è¯•...</div>
    </div>
    
    <div class="test-section">
      <h3>2. äº‹ä»¶ç›‘å¬å™¨æµ‹è¯•</h3>
      <p>æµ‹è¯•æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨æ˜¯å¦æ­£å¸¸å·¥ä½œ</p>
      <button class="test-button" id="event-test-btn">æµ‹è¯•äº‹ä»¶ç›‘å¬</button>
      <div id="event-status" class="status info">ç­‰å¾…æµ‹è¯•...</div>
    </div>
    
    <div class="test-section">
      <h3>3. APIçŠ¶æ€æ£€æŸ¥</h3>
      <p>æµ‹è¯•APIçŠ¶æ€æ£€æŸ¥åŠŸèƒ½</p>
      <button class="test-button" onclick="testApiStatus()">æ£€æŸ¥APIçŠ¶æ€</button>
      <div id="api-status" class="status info">ç­‰å¾…æµ‹è¯•...</div>
    </div>
    
    <div class="test-section">
      <h3>4. JSONè§£ææµ‹è¯•</h3>
      <p>æµ‹è¯•æ”¹è¿›çš„JSONè§£æåŠŸèƒ½</p>
      <button class="test-button" onclick="testJsonParsing()">æµ‹è¯•JSONè§£æ</button>
      <div id="json-status" class="status info">ç­‰å¾…æµ‹è¯•...</div>
    </div>
    
    <div class="test-section">
      <h3>5. è®¾ç½®æŒ‰é’®æµ‹è¯•</h3>
      <p>æµ‹è¯•è®¾ç½®æŒ‰é’®æ˜¯å¦æ­£å¸¸å·¥ä½œ</p>
      <button class="test-button" onclick="testSetupButton()">æµ‹è¯•è®¾ç½®æŒ‰é’®</button>
      <div id="setup-status" class="status info">ç­‰å¾…æµ‹è¯•...</div>
    </div>
    
    <div class="test-section">
      <h3>6. å¤–éƒ¨åº“åŠ è½½æµ‹è¯•</h3>
      <p>æµ‹è¯•Chart.jså’ŒD3.jsæ˜¯å¦æ­£å¸¸åŠ è½½</p>
      <button class="test-button" onclick="testExternalLibraries()">æµ‹è¯•å¤–éƒ¨åº“</button>
      <div id="library-status" class="status info">ç­‰å¾…æµ‹è¯•...</div>
    </div>
  </div>

  <script>
    // æµ‹è¯•CSPç­–ç•¥
    function testCSP() {
      const status = document.getElementById('csp-status');
      try {
        // æµ‹è¯•å†…è”è„šæœ¬æ‰§è¡Œ
        const testResult = 'CSPæµ‹è¯•é€šè¿‡';
        status.textContent = testResult;
        status.className = 'status success';
        console.log('CSPæµ‹è¯•é€šè¿‡');
      } catch (error) {
        status.textContent = `CSPæµ‹è¯•å¤±è´¥: ${error.message}`;
        status.className = 'status error';
        console.error('CSPæµ‹è¯•å¤±è´¥:', error);
      }
    }
    
    // æµ‹è¯•äº‹ä»¶ç›‘å¬å™¨
    document.addEventListener('DOMContentLoaded', function() {
      const eventBtn = document.getElementById('event-test-btn');
      const eventStatus = document.getElementById('event-status');
      
      if (eventBtn) {
        eventBtn.addEventListener('click', function() {
          eventStatus.textContent = 'äº‹ä»¶ç›‘å¬å™¨å·¥ä½œæ­£å¸¸ï¼';
          eventStatus.className = 'status success';
          console.log('äº‹ä»¶ç›‘å¬å™¨æµ‹è¯•é€šè¿‡');
        });
        eventStatus.textContent = 'äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®ï¼Œè¯·ç‚¹å‡»æŒ‰é’®æµ‹è¯•';
        eventStatus.className = 'status info';
      } else {
        eventStatus.textContent = 'æ— æ³•æ‰¾åˆ°æµ‹è¯•æŒ‰é’®å…ƒç´ ';
        eventStatus.className = 'status error';
      }
    });
    
    // æµ‹è¯•APIçŠ¶æ€æ£€æŸ¥
    function testApiStatus() {
      const status = document.getElementById('api-status');
      try {
        if (typeof chrome !== 'undefined' && chrome.storage) {
          chrome.storage.sync.get(['apiProvider', 'apiKey'], (result) => {
            if (result.apiProvider && result.apiKey) {
              status.textContent = `APIå·²é…ç½®: ${result.apiProvider}`;
              status.className = 'status success';
            } else {
              status.textContent = 'APIæœªé…ç½®ï¼Œè¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®API';
              status.className = 'status error';
            }
          });
        } else {
          status.textContent = 'Chromeæ‰©å±•APIä¸å¯ç”¨';
          status.className = 'status error';
        }
      } catch (error) {
        status.textContent = `APIçŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`;
        status.className = 'status error';
      }
    }
    
    // æµ‹è¯•JSONè§£æ
    function testJsonParsing() {
      const status = document.getElementById('json-status');
      try {
        // æ¨¡æ‹Ÿæœ‰é—®é¢˜çš„JSON
        const badJson = `{
          "æŠ€æœ¯": [
            {"title": "GitHub", "url": "https://github.com"},
            {"title": "Stack Overflow", "url": "https://stackoverflow.com"}
          ],
          "å¨±ä¹": [
            {"title": "YouTube", "url": "https://youtube.com"}
          ]
        `; // æ•…æ„ç¼ºå°‘é—­åˆæ‹¬å·
        
        // ä½¿ç”¨æ”¹è¿›çš„è§£æå‡½æ•°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if (typeof parseJsonWithRecovery === 'function') {
          const result = parseJsonWithRecovery(badJson);
          status.textContent = `JSONè§£ææˆåŠŸï¼Œæ‰¾åˆ° ${Object.keys(result).length} ä¸ªåˆ†ç±»`;
          status.className = 'status success';
        } else {
          // ä½¿ç”¨æ ‡å‡†JSON.parse
          const result = JSON.parse(badJson + '}'); // æ‰‹åŠ¨ä¿®å¤
          status.textContent = `æ ‡å‡†JSONè§£ææˆåŠŸï¼Œæ‰¾åˆ° ${Object.keys(result).length} ä¸ªåˆ†ç±»`;
          status.className = 'status success';
        }
      } catch (error) {
        status.textContent = `JSONè§£æå¤±è´¥: ${error.message}`;
        status.className = 'status error';
      }
    }
    
    // æµ‹è¯•è®¾ç½®æŒ‰é’®
    function testSetupButton() {
      const status = document.getElementById('setup-status');
      try {
        if (typeof chrome !== 'undefined' && chrome.runtime) {
          chrome.runtime.openOptionsPage();
          status.textContent = 'è®¾ç½®é¡µé¢å·²æ‰“å¼€';
          status.className = 'status success';
        } else {
          status.textContent = 'Chromeæ‰©å±•APIä¸å¯ç”¨';
          status.className = 'status error';
        }
      } catch (error) {
        status.textContent = `è®¾ç½®æŒ‰é’®æµ‹è¯•å¤±è´¥: ${error.message}`;
        status.className = 'status error';
      }
    }
    
    // æµ‹è¯•å¤–éƒ¨åº“åŠ è½½
    function testExternalLibraries() {
      const status = document.getElementById('library-status');
      const results = [];
      
      if (typeof Chart !== 'undefined') {
        results.push('Chart.js âœ“');
      } else {
        results.push('Chart.js âœ—');
      }
      
      if (typeof d3 !== 'undefined') {
        results.push('D3.js âœ“');
      } else {
        results.push('D3.js âœ—');
      }
      
      if (results.every(r => r.includes('âœ“'))) {
        status.textContent = `æ‰€æœ‰å¤–éƒ¨åº“åŠ è½½æˆåŠŸ: ${results.join(', ')}`;
        status.className = 'status success';
      } else {
        status.textContent = `éƒ¨åˆ†åº“åŠ è½½å¤±è´¥: ${results.join(', ')}`;
        status.className = 'status error';
      }
    }
    
    // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      console.log('æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
      
      // è‡ªåŠ¨è¿è¡Œä¸€äº›åŸºæœ¬æµ‹è¯•
      setTimeout(() => {
        testCSP();
        testExternalLibraries();
      }, 1000);
    });
  </script>
</body>
</html> 